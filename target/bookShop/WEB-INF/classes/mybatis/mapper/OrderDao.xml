<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xupt.bookshop.dao.OrderDao">

    <parameterMap id="orderParamType" type="com.xupt.bookshop.model.order.Orders">
        <parameter property="linkman" />
        <parameter property="telphone"/>
        <parameter property="totalPrice"/>
        <parameter property="status" javaType="com.xupt.bookshop.model.enums.OrderState" jdbcType="TINYINT" typeHandler="EnumTypeHandler"/>
        <parameter property="orderTime"  javaType="org.joda.time.DateTime" jdbcType="TIMESTAMP" typeHandler="DateTimeTypeHandler"/>
        <parameter property="address" />
    </parameterMap>

<resultMap id="orderItemresult" type="com.xupt.bookshop.model.order.Orders">
  <result column="OrderID" property="OrderId"/>
    <result column="user_name" property="username"/>
    <result column="linkman" property="linkman"/>
    <result column="Address" property="address"/>
    <result column="Telphone" property="telphone"/>
    <result column="order_time" property="orderTime" typeHandler="DateTimeTypeHandler"/>
    <result column="Status" property="status" typeHandler="EnumTypeHandler"/>
    <result column="total_price" property="totalPrice"/>
</resultMap>

    <select id="queryOrderDetails" resultMap="orderItemresult" parameterType="String">
        SELECT OrderID,user_name,linkman,Address,Telphone,order_time,Status ,total_price FROM orders
         WHERE user_name=#{username}
    </select>
    <select id="queryOrderItem" resultType="com.xupt.bookshop.model.order.OrderItem">
        SELECT book_name,price,current_price,buycount FROM order_item
        WHERE  order_id=#{orderId}
    </select>
    <insert id="createOrders" parameterType="com.xupt.bookshop.model.order.Orders">
        INSERT into orders (OrderID, user_name,linkman, Address, Telphone, order_time, Status)
        VALUES (#{order.OrderId},#{order.username},#{order.linkman},#{order.address},#{order.telphone},#{order.orderTime,typeHandler=DateTimeTypeHandler},#{order.status,typeHandler=EnumTypeHandler})
    </insert>

    <insert id="createOrderItem" parameterType="com.xupt.bookshop.model.order.Orders">
        INSERT into order_item(order_id,book_name,price,current_price,buycount)
        VALUES
        <foreach collection="orderItem.cartItems" separator="," item="item">
            (#{orderItem.OrderId},#{item.bookName},#{item.price},#{item.currentPrice},#{item.buyNum})
        </foreach>
    </insert>


    <select id="selectOrderItemWithTime" resultType="String">
        SELECT  orders.OrderID FROM orders WHERE
        (select date_sub(curdate(),interval 1 day))>order_time
          AND Status=#{state,typeHandler=EnumTypeHandler}
    </select>

    <select id="queryOrderByState" resultMap="orderItemresult">
       SELECT * FROM orders
       WHERE
       user_name=#{username}
       AND
       Status=#{state}

    </select>


    <select id="queryOrderPagesWithState" resultType="int">
       SELECT COUNT(*) FROM orders
       WHERE
       user_name=#{username}
       AND
       Status=#{state}

    </select>


    <select id="queryOrderPages" resultType="int">
        SELECT COUNT(*) FROM orders
        WHERE user_name=#{username}

    </select>

    <update id="updateOrderStatus">
        UPDATE  orders SET Status=#{orderState,typeHandler=EnumTypeHandler}
    </update>


    <update id="insertTotalPrice" >
        UPDATE  orders SET
        total_price=#{totalPrice}
    </update>
</mapper>